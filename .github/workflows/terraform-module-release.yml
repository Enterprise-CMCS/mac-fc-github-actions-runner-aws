name: Release Terraform Module

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  validate:
    name: Validate Module
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="v${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ~1.0

      - name: Terraform Format Check
        run: |
          cd codebuild
          terraform fmt -check

      - name: Terraform Init
        run: |
          cd codebuild
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd codebuild
          terraform validate

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release Notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Terraform AWS CodeBuild GitHub Runner Module

          ## Version ${{ needs.validate.outputs.version }}

          ### Quick Start

          ```hcl
          module "github_runner" {
            source = "github.com/${{ github.repository }}//codebuild?ref=${{ needs.validate.outputs.version }}"

            github_owner       = "your-org"
            github_repository  = "your-repo"
            github_secret_name = "github/actions/token"
            project_name       = "my-project"
          }
          ```

          ### Features

          - Complete Terraform module for CodeBuild GitHub Actions runners
          - Zero-maintenance serverless architecture
          - ~40% cost savings vs GitHub-hosted runners
          - AWS IAM integration with least privilege
          - CloudWatch logging and S3 caching
          - VPC support for network isolation

          ### Documentation

          See the [README](https://github.com/${{ github.repository }}/blob/main/codebuild/README.md) for complete documentation and examples.

          ### Contributing

          Contributions welcome! Please open an issue or pull request.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: Release ${{ needs.validate.outputs.version }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: false
          generate_release_notes: true

      - name: Create Module Archive
        run: |
          cd codebuild
          tar -czf ../codebuild-${{ needs.validate.outputs.version }}.tar.gz \
            --exclude='.terraform*' \
            --exclude='*.tfstate*' \
            --exclude='terraform.tfvars' \
            .

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          files: |
            codebuild-${{ needs.validate.outputs.version }}.tar.gz

  usage:
    name: Print Usage Instructions
    runs-on: ubuntu-latest
    needs: [validate, release]
    if: always() && needs.validate.result == 'success'

    steps:
      - name: Usage Instructions
        run: |
          echo "Module Released Successfully!"
          echo "================================="
          echo ""
          echo "To use this module in your Terraform:"
          echo ""
          echo "module \"github_runner\" {"
          echo "  source = \"github.com/${{ github.repository }}//codebuild?ref=${{ needs.validate.outputs.version }}\""
          echo "  "
          echo "  github_owner       = \"your-org\""
          echo "  github_repository  = \"your-repo\""
          echo "  github_secret_name = \"github/actions/token\""
          echo "  project_name       = \"my-project\""
          echo "}"
          echo ""
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.validate.outputs.version }}"